// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  firstName String?
  lastName  String?
  phone     String?
  country   String?
  currency  String?    @default("NGN") // User's preferred currency
  
  bookings  Booking[]
  payments  Payment[]
  reviews   Review[]
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

// Room model for properties
model Room {
  id          String     @id @default(cuid())
  title       String
  description String?
  priceNGN    Float      // Price in Nigerian Naira
  capacity    Int        // Number of guests
  amenities   String[]   // JSON array of amenities
  images      String[]   // Array of image URLs
  status      String     @default("AVAILABLE") // AVAILABLE, UNAVAILABLE, MAINTENANCE
  
  bookings    Booking[]
  reviews     Review[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Booking model with double-booking prevention
model Booking {
  id            String     @id @default(cuid())
  
  userId        String
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  roomId        String
  room          Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  checkInDate   DateTime   // Start date of booking
  checkOutDate  DateTime   // End date of booking
  
  numberOfGuests Int
  specialRequests String?
  
  // Prevent double-booking at database level: unique constraint on (roomId, overlapping dates)
  // This is handled by a unique constraint ensuring no overlapping bookings
  @@unique([roomId, checkInDate, checkOutDate])
  
  status        String     @default("PENDING") // PENDING, CONFIRMED, CANCELLED, COMPLETED
  
  // Payment tracking
  payment       Payment?
  transactions  Transaction[]
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

// Payment model for Paystack integration
model Payment {
  id              String     @id @default(cuid())
  
  bookingId       String     @unique
  booking         Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Amount in Nigerian Naira (base currency)
  amountNGN       Float
  
  // User's original currency and amount
  userCurrency    String     @default("NGN")
  userAmount      Float      // Amount in user's currency
  
  // Exchange rate used for conversion
  exchangeRate    Float      @default(1.0)
  
  // Paystack reference for webhook verification
  paystackReference String?  @unique
  
  // Payment status
  status          String     @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, REFUNDED
  
  // Payment method
  paymentMethod   String     @default("card") // card, bank_transfer, ussd, etc.
  
  // Metadata
  metadata        Json?      // Additional payment info
  
  // Receipt
  receiptUrl      String?
  
  transactions    Transaction[]
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

// Transaction model for audit trail
model Transaction {
  id              String     @id @default(cuid())
  
  bookingId       String
  booking         Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  paymentId       String
  payment         Payment    @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  
  type            String     // BOOKING_CREATED, PAYMENT_INITIATED, PAYMENT_COMPLETED, REFUND_INITIATED, etc.
  
  amount          Float
  currency        String
  
  status          String     @default("PENDING") // PENDING, SUCCESS, FAILED
  
  description     String?
  
  // Additional metadata for tracking
  metadata        Json?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

// Review model for guests
model Review {
  id          String     @id @default(cuid())
  
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  roomId      String
  room        Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  rating      Int        // 1-5 star rating
  comment     String?
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Model for tracking exchange rates
model ExchangeRate {
  id          String     @id @default(cuid())
  
  fromCurrency String    // Source currency (e.g., NGN)
  toCurrency   String    // Target currency (e.g., USD)
  
  rate        Float     // Exchange rate
  
  source      String?   // API source (e.g., open-exchange-rates)
  
  createdAt   DateTime   @default(now())
  expiresAt   DateTime   // When this rate expires
  
  @@unique([fromCurrency, toCurrency])
}

// Menu Category model
model MenuCategory {
  id          String     @id @default(cuid())
  name        String     @unique  // e.g., "Breakfast", "Lunch & Dinner"
  description String?
  timing      String?    // e.g., "7:00 AM â€“ 10:00 AM DAILY"
  note        String?    // Special notes like buffet/a la carte info
  isActive    Boolean    @default(true)
  displayOrder Int?      // Order to display categories
  
  items       MenuItem[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Menu Item model
model MenuItem {
  id          String     @id @default(cuid())
  
  categoryId  String
  category    MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  name        String     // e.g., "Toast Bread"
  description String?    // Item description
  priceNGN    Float      // Price in Nigerian Naira
  
  isActive    Boolean    @default(true)
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@unique([categoryId, name])
  @@index([categoryId])
}
